<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pitada.io | Suite Técnica Pro</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/heatmap.js@2.0.5/build/heatmap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    
    <style>
        /* === ESTILOS BASE === */
        :root { --bg-body:#0b0f19; --bg-card:#111827; --text-main:#f3f4f6; --text-muted:#9ca3af; --border:#374151; --sidebar-bg:#111827; --primary:#6366f1; --success:#10b981; --warning:#f59e0b; --danger:#ef4444; --radius-md:12px; --shadow-card:0 4px 6px -1px rgba(0,0,0,0.05); }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Inter', sans-serif; background-color:var(--bg-body); color:var(--text-main); background-image:radial-gradient(circle at 10% 20%, rgba(99,102,241,0.08) 0%, transparent 20%), radial-gradient(circle at 90% 80%, rgba(16,185,129,0.05) 0%, transparent 20%); min-height:100vh; transition:background 0.3s, color 0.3s; }
        
        .app-container { display:grid; grid-template-columns:260px 1fr; min-height:100vh; }
        .sidebar { background:var(--sidebar-bg); border-right:1px solid var(--border); padding:2rem 1.5rem; display:flex; flex-direction:column; gap:2rem; position:sticky; top:0; height:100vh; z-index:100; transition:background 0.3s; }
        .main-content { padding:2rem 3rem; overflow-y:auto; overflow-x:hidden; }
        .logo { font-family:'Outfit', sans-serif; font-size:1.5rem; font-weight:700; display:flex; align-items:center; gap:0.75rem; color:var(--text-main); }
        .logo-icon { width:40px; height:40px; background:linear-gradient(135deg, var(--primary), var(--success)); border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:1.2rem; color:white; box-shadow:0 0 15px var(--primary-glow); }
        .nav-item { display:flex; align-items:center; gap:1rem; padding:1rem; border-radius:8px; color:var(--text-muted); text-decoration:none; transition:all 0.3s ease; font-weight:500; cursor:pointer; }
        .nav-item:hover, .nav-item.active { background:rgba(99,102,241,0.1); color:var(--primary); }
        .nav-item.active { border-left:3px solid var(--primary); }
        .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:2.5rem; }
        .header-title h1 { font-family:'Outfit', sans-serif; font-size:2rem; font-weight:600; }
        .header-title p { color:var(--text-muted); }
        
        .btn-primary { background:linear-gradient(135deg, var(--primary), #4f46e5); color:white; padding:0.75rem 1.5rem; border-radius:50px; border:none; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:0.5rem; box-shadow:0 4px 15px var(--primary-glow); transition:transform 0.2s; }
        .btn-primary:hover { transform:translateY(-2px); }
        .btn-outline { background:transparent; border:1px solid var(--border); color:var(--text-muted); padding:0.5rem 1rem; border-radius:50px; font-size:0.9rem; cursor:pointer; display:flex; align-items:center; gap:0.5rem; transition:all 0.2s; }
        .btn-outline:hover { border-color:var(--primary); color:var(--primary); }
        .profile-btn { display:flex; align-items:center; gap:0.75rem; cursor:pointer; padding:0.5rem; border-radius:50px; transition:background 0.2s; }
        .profile-btn:hover { background:rgba(255,255,255,0.05); }
        .avatar { width:42px; height:42px; background:linear-gradient(to right, #8b5cf6, #d946ef); border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-weight:700; border:2px solid var(--bg-card); }
        select.player-selector, .comparison-controls select, .form-input, .indiv-heatmap-controls select, .formation-select { width:100%; padding:0.6rem 1rem; border-radius:8px; border:1px solid var(--border); background-color:var(--bg-body); color:var(--text-main); font-family:'Inter', sans-serif; font-size:0.9rem; outline:none; cursor:pointer; transition:all 0.2s; appearance:none; -webkit-appearance:none; background-image:url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%236b7280%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat:no-repeat; background-position:right 0.7rem top 50%; background-size:0.65rem auto; padding-right:2.5rem; }
        select:focus, .form-input:focus { border-color:var(--primary); box-shadow:0 0 0 2px var(--primary-glow); }
        
        .dropdown-menu { position:absolute; top:120%; right:0; width:240px; background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-md); padding:0.5rem; display:none; z-index:1000; box-shadow:0 10px 25px -5px rgba(0,0,0,0.5); animation:fadeIn 0.2s ease; }
        .dropdown-menu.show { display:block; }
        .menu-item { display:flex; align-items:center; gap:0.75rem; padding:0.75rem 1rem; color:var(--text-muted); text-decoration:none; border-radius:8px; transition:all 0.2s; cursor:pointer; font-size:0.9rem; }
        .menu-item:hover { background:rgba(99,102,241,0.1); color:var(--text-main); }
        .menu-header { padding:1rem; border-bottom:1px solid var(--border); margin-bottom:0.5rem; }
        .modal { display:none; position:fixed; z-index:2000; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.6); backdrop-filter:blur(5px); animation:fadeIn 0.2s; }
        .modal-content { background-color:var(--bg-card); margin:10% auto; padding:2rem; border:1px solid var(--border); width:100%; max-width:400px; border-radius:var(--radius-md); box-shadow:0 20px 25px -5px rgba(0,0,0,0.5); }
        .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem; }
        .modal-title { font-size:1.25rem; font-weight:700; color:var(--text-main); }
        .close-modal { color:var(--text-muted); font-size:1.5rem; font-weight:bold; cursor:pointer; }
        .form-group { margin-bottom:1rem; }
        .form-label { display:block; font-size:0.85rem; color:var(--text-muted); margin-bottom:0.5rem; }
        .form-actions { display:flex; gap:1rem; margin-top:1.5rem; }
        .btn-cancel { background:transparent; border:1px solid var(--border); color:var(--text-muted); padding:0.75rem; border-radius:50px; flex:1; cursor:pointer; }

        .view-section { display:none; animation:fadeIn 0.3s ease; }
        .view-section.active { display:block; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }

        .dashboard-grid { display:grid; grid-template-columns:repeat(12, 1fr); gap:1.5rem; width:100%; }
        .card { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-md); padding:1.5rem; position:relative; transition:border-color 0.3s; min-width:0; overflow:visible; }
        .card:hover { border-color:var(--primary); }
        .card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem; flex-wrap:wrap; gap:15px; }
        .card-title { margin-right:auto; }

        .stat-grid { grid-column:span 12; display:grid; grid-template-columns:repeat(4, 1fr); gap:1.5rem; margin-bottom:1.5rem; }
        .kpi-card { background:linear-gradient(145deg, var(--bg-card), rgba(99,102,241,0.03)); border:1px solid var(--border); border-radius:var(--radius-md); padding:1.5rem; display:flex; align-items:center; gap:1rem; box-shadow:var(--shadow-card); }
        .kpi-icon { width:50px; height:50px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:1.25rem; flex-shrink:0; }
        .kpi-value { font-size:1.75rem; font-weight:700; font-family:'Outfit'; color:var(--text-main); }
        .kpi-label { font-size:0.85rem; color:var(--text-muted); }

        .tactical-board { grid-column:span 8; }
        .side-panel { grid-column:span 4; display:flex; flex-direction:column; gap:1.5rem; }
        .cancha-wrapper { width:100%; height:400px; background:linear-gradient(to bottom right, #1a4d2e, #14532d); border-radius:8px; position:relative; overflow:visible; box-shadow:inset 0 0 50px rgba(0,0,0,0.5); border:2px solid rgba(255,255,255,0.1); }
        .cancha-bg-clip { position:absolute; top:0; left:0; width:100%; height:100%; overflow:hidden; border-radius:6px; pointer-events:none; }
        .layer-overlay { width:100%; height:100%; position:absolute; top:0; left:0; transition:opacity 0.3s; } 
        .hidden-layer { opacity:0; pointer-events:none !important; }
        
        .shot-marker { position:absolute; width:14px; height:14px; border-radius:50%; border:2px solid white; transform:translate(-50%, -50%); transition:transform 0.2s; z-index:10; cursor:pointer; }
        .shot-gol { background-color:var(--success); } .shot-atajada { background-color:var(--warning); border-radius:3px; } .shot-fuera { background-color:var(--danger); }
        
        .player-node { 
            position:absolute; width:34px; height:34px; 
            background:var(--bg-card); border:2px solid var(--text-main); border-radius:50%; 
            display:flex; align-items:center; justify-content:center; 
            font-size:0.85rem; font-weight:700; color:var(--text-main); 
            transform:translate(-50%, -50%); box-shadow:0 4px 10px rgba(0,0,0,0.5); 
            z-index:20; cursor: grab; transition: box-shadow 0.1s;
        }
        .player-node:hover { border-color:var(--primary); transform:translate(-50%, -50%) scale(1.1); }
        .player-node:active { cursor: grabbing; box-shadow: 0 0 15px var(--primary); border-color: var(--primary); }

        .pass-line { stroke:var(--text-muted); stroke-linecap:round; transition:all 0.1s; opacity:0.6; pointer-events:none; }
        .action-zone { fill: var(--primary); fill-opacity: 0.15; stroke: var(--primary); stroke-width: 1; stroke-opacity: 0.4; transition: all 0.3s ease; }
        .action-zone.zone-def { fill: #ef4444; stroke: #ef4444; } .action-zone.zone-mid { fill: #f59e0b; stroke: #f59e0b; } .action-zone.zone-del { fill: #10b981; stroke: #10b981; } 
        
        .tactical-tooltip { position:fixed; background:rgba(17,24,39,0.95); color:white; padding:0.6rem 1rem; border-radius:8px; font-size:0.85rem; pointer-events:none; z-index:9999; border:1px solid var(--border); display:none; backdrop-filter:blur(4px); white-space:nowrap; box-shadow:0 10px 25px rgba(0,0,0,0.5); }
        
        .mode-switch { display:flex; background:var(--border); padding:4px; border-radius:8px; gap:4px; overflow-x:auto; }
        .mode-btn { padding:0.4rem 0.8rem; border-radius:6px; border:none; cursor:pointer; font-size:0.85rem; font-weight:500; color:var(--text-muted); background:transparent; transition:all 0.2s; white-space:nowrap; }
        .mode-btn.active { background:var(--bg-card); color:var(--text-main); box-shadow:0 2px 4px rgba(0,0,0,0.1); }
        .sub-controls { display:flex; gap:0.5rem; margin-left:1rem; }
        .sub-btn { background:transparent; border:1px solid var(--border); color:var(--text-muted); padding:0.3rem 0.8rem; border-radius:6px; cursor:pointer; font-size:0.8rem; }
        .sub-btn.active { border-color:var(--primary); color:var(--primary); background:rgba(99,102,241,0.1); }
        .legend-container { display:flex; gap:1rem; margin-top:1rem; font-size:0.85rem; color:var(--text-muted); flex-wrap:wrap; }
        .legend-item { display:flex; align-items:center; gap:0.4rem; }
        .dot { width:8px; height:8px; border-radius:50%; }

        .leaders-grid { display:grid; grid-template-columns:repeat(4, 1fr); gap:1.5rem; }
        .leader-card { background:rgba(255,255,255,0.03); border:1px solid var(--border); border-radius:12px; padding:1rem; display:flex; align-items:center; gap:1rem; position:relative; transition:transform 0.2s; }
        .leader-avatar { position:relative; flex-shrink:0; } .avatar-img { width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; color:white; box-shadow:0 4px 10px rgba(0,0,0,0.3); }
        .leader-info { flex:1; min-width:0; } .leader-name { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; } .leader-value { font-weight:700; color:var(--text-main); font-family:'Outfit'; font-size:1.1rem; }
        .progress-mini { width:100%; height:3px; background:rgba(255,255,255,0.1); border-radius:2px; margin-top:5px; } .progress-mini .bar { height:100%; border-radius:2px; }
        .radar-card, .comparison-card { grid-column:span 6; } .radar-wrapper { display:flex; gap:2rem; align-items:center; justify-content:center; min-height:300px; }
        .player-info-panel { flex:1; display:flex; flex-direction:column; gap:1rem; } .player-stats-list { display:grid; grid-template-columns:1fr 1fr; gap:0.5rem; margin-top:1rem; }
        .p-stat { background:var(--bg-body); padding:0.5rem; border-radius:6px; font-size:0.8rem; display:flex; justify-content:space-between; } .p-stat strong { color:var(--text-main); }
        .chart-radar-container { flex:1; height:300px; position:relative; width:100%; }
        .indiv-heatmap-card { grid-column:span 12; display:flex; gap:1.5rem; } .indiv-heatmap-controls { width:250px; display:flex; flex-direction:column; gap:1rem; flex-shrink:0; } .indiv-heatmap-wrapper { flex:1; height:350px; background:linear-gradient(to bottom right, #1a4d2e, #14532d); border-radius:8px; position:relative; border:2px solid rgba(255,255,255,0.1); box-shadow:inset 0 0 50px rgba(0,0,0,0.5); }
        .indiv-stat-row { display:flex; justify-content:space-between; padding:0.75rem; background:var(--bg-body); border-radius:8px; font-size:0.9rem; }
        .reco-item { background:rgba(99,102,241,0.05); border-left:3px solid var(--primary); padding:1rem; border-radius:0 8px 8px 0; margin-bottom:0.75rem; }
        .reco-item.alert { border-color:var(--danger); background:rgba(239,68,68,0.05); }
        .upload-zone { border:2px dashed var(--border); border-radius:var(--radius-md); padding:2rem; text-align:center; cursor:pointer; transition:all 0.3s; }
        .upload-zone:hover { border-color:var(--primary); background:rgba(99,102,241,0.05); }

        .squad-filters { display:flex; gap:1rem; margin-bottom:2rem; overflow-x:auto; padding-bottom:0.5rem; }
        .filter-btn { background:var(--bg-card); border:1px solid var(--border); color:var(--text-muted); padding:0.5rem 1.2rem; border-radius:50px; font-size:0.9rem; font-weight:500; cursor:pointer; transition:all 0.2s; white-space:nowrap; }
        .filter-btn.active, .filter-btn:hover { background:var(--primary); color:white; border-color:var(--primary); }
        .search-box { margin-bottom:1.5rem; position:relative; max-width:400px; }
        .search-box i { position:absolute; left:1rem; top:50%; transform:translateY(-50%); color:var(--text-muted); }
        .search-input { width:100%; padding:0.75rem 1rem 0.75rem 2.5rem; border-radius:50px; border:1px solid var(--border); background:var(--bg-card); color:var(--text-main); font-family:'Inter'; transition:all 0.2s; }
        .search-input:focus { border-color:var(--primary); outline:none; box-shadow:0 0 0 3px var(--primary-glow); }
        .squad-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(240px, 1fr)); gap:1.5rem; }
        .player-card { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-md); overflow:visible; position:relative; transition:transform 0.2s; }
        .player-card:hover { transform:translateY(-5px); border-color:var(--primary); }
        .player-card-header { padding:1.5rem; display:flex; align-items:center; gap:1rem; border-bottom:1px solid var(--border); }
        .p-avatar { width:50px; height:50px; border-radius:50%; background:var(--bg-body); border:2px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:1.1rem; font-weight:700; color:var(--text-main); flex-shrink:0; }
        .p-info h3 { margin:0; font-size:1rem; color:var(--text-main); } .p-info p { margin:0; font-size:0.8rem; color:var(--text-muted); }
        .p-number { position:absolute; top:1rem; right:1rem; font-size:1.2rem; font-weight:800; color:rgba(255,255,255,0.05); font-family:'Outfit'; }
        .player-card-body { padding:1rem; display:flex; justify-content:space-between; align-items:center; }
        .delete-btn { color:var(--text-muted); cursor:pointer; transition:color 0.2s; font-size:0.9rem; margin-left:10px; }
        .delete-btn:hover { color:var(--danger); }
        .p-tags { flex:1; }
        .status-btn { border:none; cursor:pointer; transition:all 0.2s; white-space:nowrap; display:flex; align-items:center; gap:6px; width:100%; justify-content:center; font-size:0.75rem; padding:0.4rem 0.8rem; border-radius:6px; font-weight:600; text-transform:uppercase; }
        .status-btn:hover { filter:brightness(1.1); transform:scale(1.02); }
        .tag-fit { background:rgba(16,185,129,0.1); color:var(--success); border:1px solid rgba(16,185,129,0.2); }
        .tag-injured { background:rgba(239,68,68,0.1); color:var(--danger); border:1px solid rgba(239,68,68,0.2); }
        .tag-yellow { background:rgba(245,158,11,0.15); color:#fbbf24; border:1px solid rgba(245,158,11,0.3); }
        .tag-red { background:rgba(239,68,68,0.15); color:#f87171; border:1px solid rgba(239,68,68,0.3); }

        /* VIDEO PLACEHOLDER */
        #videoPlaceholder {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 100%; height: 100%; color: var(--text-muted);
            background: linear-gradient(145deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
            border: 1px dashed var(--border); border-radius: 12px; text-align: center;
            position: absolute; top:0; left:0; z-index: 10;
        }
        #videoPlaceholder i { font-size: 3rem; margin-bottom: 1rem; color: var(--primary); opacity: 0.8; }
        #videoPlaceholder h3 { color: var(--text-main); font-weight: 600; margin-bottom: 0.5rem; }
        #videoPlaceholder p { font-size: 0.9rem; opacity: 0.7; }
        /* OCULTAR VIDEO POR DEFECTO PERO MANTENER ESPACIO */
        #matchVideo { width:100%; height:100%; object-fit:contain; display:none; }

        @media (max-width: 1024px) { .app-container { grid-template-columns:1fr; } .sidebar { display:none; } .tactical-board, .radar-card, .comparison-card, .indiv-heatmap-card, .card { grid-column:span 12; } .radar-wrapper, .indiv-heatmap-card { flex-direction:column; } .indiv-heatmap-controls { width:100%; } .side-panel { grid-column:span 12; display:flex; flex-direction:row; gap:1rem; } .stat-grid, .leaders-grid { grid-template-columns:repeat(2, 1fr); } .video-layout { grid-template-columns:1fr; height:auto; } .video-player-container { height:300px; } .events-sidebar { height:300px; } }
        @media (max-width: 600px) { .leaders-grid, .stat-grid, .squad-grid { grid-template-columns:1fr; } .side-panel { flex-direction:column; } .report-item { flex-direction:column; align-items:flex-start; gap:1rem; } }
    </style>
</head>
<body>

<script>
    // === 1. VARIABLES GLOBALES ===
    let MATCH_DATA = { totalFrames: 0, playersHistory: [], possession: { local: 0, visit: 0 }, heatmapPoints: [], shots: [], passes: [], nodePositions: {} };
    let latestBallPos = { x: 0.5, y: 0.5 };
    let aiModel = null;
    let isAiActive = false;
    let trackedObjects = [];
    let frameCount = 0;
    const FRAME_SKIP = 2;
    let videoEvents = JSON.parse(localStorage.getItem('pitada_video_events')) || [];
    let squadDB = JSON.parse(localStorage.getItem('pitada_squad')) || [
        { id: 1, name: 'Claudio Bravo', num: 1, pos: 'POR', status: 'fit' }, 
        { id: 2, name: 'Gary Medel', num: 17, pos: 'DEF', status: 'yellow' }, 
        { id: 7, name: 'Alexis Sánchez', num: 7, pos: 'DEL', status: 'fit' }, 
        { id: 8, name: 'Arturo Vidal', num: 8, pos: 'MED', status: 'fit' },
        { id: 3, name: 'Mauricio Isla', num: 4, pos: 'DEF', status: 'fit' },
        { id: 5, name: 'Paulo Diaz', num: 5, pos: 'DEF', status: 'fit' },
        { id: 20, name: 'Charles Aranguiz', num: 20, pos: 'MED', status: 'fit' },
        { id: 13, name: 'Erick Pulgar', num: 13, pos: 'MED', status: 'fit' },
        { id: 10, name: 'Ben Brereton', num: 22, pos: 'DEL', status: 'fit' },
        { id: 11, name: 'Eduardo Vargas', num: 11, pos: 'DEL', status: 'fit' },
        { id: 6, name: 'Guillermo Maripan', num: 3, pos: 'DEF', status: 'fit' }
    ];
    let currentFilter='all', currentSearch='';
    let heatmapInstance = null;
    let possessionChart = null;
    let radarChartInstance = null;
    let momentumChartInstance = null;
    let comparisonChartInstance = null;
    let individualHeatmapInstance = null;

    // === 2. FUNCIONES GLOBALES ===

    window.showToast = function(msg, type = 'success') {
        const c = document.getElementById('toastContainer');
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        t.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i> ${msg}`;
        c.appendChild(t);
        setTimeout(() => { t.style.animation = 'slideOut 0.3s forwards'; setTimeout(() => t.remove(), 300); }, 3000);
    }

    window.navigate = function(id) { 
        document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); 
        const target = document.getElementById('view-'+id);
        if(target) target.classList.add('active');
        
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        const navItem = document.getElementById('nav-'+id);
        if(navItem) navItem.classList.add('active');
        
        if(id === 'dashboard') setTimeout(updateDashboardVisuals, 200); 
        if(id === 'tacticas') setTimeout(() => applyFormation('442'), 200);
    };

    window.toggleAI = async function() {
        const videoElement = document.getElementById('matchVideo');
        if (isAiActive) {
            isAiActive = false;
            document.getElementById('aiCanvas').getContext('2d').clearRect(0, 0, videoElement.videoWidth, videoElement.videoHeight);
            document.getElementById('aiStatsOverlay').style.display = 'none';
            showToast("Tracking Pausado");
            return;
        }
        if (videoElement.style.display === 'none') { showToast("Primero sube un video", "error"); return; }

        document.getElementById('aiLoading').style.display = 'block';
        if (!aiModel) {
            try { aiModel = await cocoSsd.load({ base: 'lite_mobilenet_v2' }); showToast("IA Lista", "success"); } 
            catch (error) { console.error(error); document.getElementById('aiLoading').style.display = 'none'; return; }
        }
        document.getElementById('aiLoading').style.display = 'none';
        document.getElementById('aiStatsOverlay').style.display = 'block';
        isAiActive = true;
        
        const canvas = document.getElementById('aiCanvas');
        canvas.width = videoElement.videoWidth; canvas.height = videoElement.videoHeight;
        detectFrame();
        videoElement.play();
    };

    window.tagEvent = function(t){ 
        const videoElement = document.getElementById('matchVideo');
        if(videoElement.style.display === 'none') { showToast("Sube un video primero", "error"); return; }
        const time = videoElement.currentTime/60;
        let label = t.charAt(0).toUpperCase() + t.slice(1);
        videoEvents.push({time: time, type:t, label: label}); 
        localStorage.setItem('pitada_video_events', JSON.stringify(videoEvents)); 
        if(t==='gol' || t==='tiro' || t==='falta'){ MATCH_DATA.shots.push({x: latestBallPos.x, y: latestBallPos.y, result: t}); showToast(t.toUpperCase() + " registrado en mapa"); }
        else { showToast("Clip guardado"); }
        renderVideoEvents(); 
    };
    
    window.jumpToVideo = function(t){ 
        const videoElement = document.getElementById('matchVideo');
        if(videoElement.style.display !== 'none') {
            videoElement.currentTime = t*60; 
            videoElement.play(); 
        }
    };

    window.openPassModal = function() {
        const fromSel = document.getElementById('passFrom');
        const toSel = document.getElementById('passTo');
        fromSel.innerHTML = ''; toSel.innerHTML = '';
        squadDB.forEach(p => {
            const opt = `<option value="${p.id}">${p.num} - ${p.name}</option>`;
            fromSel.innerHTML += opt; toSel.innerHTML += opt;
        });
        document.getElementById('passModal').style.display = 'flex';
    };

    window.savePass = function() {
        const from = document.getElementById('passFrom').value;
        const to = document.getElementById('passTo').value;
        if(from && to && from !== to) {
            const videoElement = document.getElementById('matchVideo');
            MATCH_DATA.passes.push({from: from, to: to, time: videoElement.currentTime});
            showToast("Pase registrado");
            document.getElementById('passModal').style.display = 'none';
        }
    };
    
    window.closePassModal = function() { document.getElementById('passModal').style.display = 'none'; };

    // === 3. LÓGICA INTERNA ===
    async function detectFrame() {
        const videoElement = document.getElementById('matchVideo');
        if (!isAiActive || videoElement.paused || videoElement.ended) { if(isAiActive && !videoElement.paused) requestAnimationFrame(detectFrame); return; }
        if (frameCount % FRAME_SKIP === 0) {
            try {
                const predictions = await aiModel.detect(videoElement);
                let freshDetections = predictions.filter(p => (p.class === 'person' && p.score > 0.35) || (p.class === 'sports ball' && p.score > 0.4));
                freshDetections = freshDetections.filter(p => p.bbox[2] < videoElement.videoWidth * 0.4);
                freshDetections = freshDetections.map(p => {
                    if(p.class === 'sports ball') { latestBallPos = { x: (p.bbox[0] + p.bbox[2]/2) / videoElement.videoWidth, y: (p.bbox[1] + p.bbox[3]/2) / videoElement.videoHeight }; }
                    return { ...p, color: '#10b981' }; 
                });
                updateTracker(freshDetections);
            } catch (e) {}
        }
        frameCount++;
        drawSmartTracking();
        requestAnimationFrame(detectFrame);
    }

    function updateTracker(detections) {
        const canvas = document.getElementById('aiCanvas');
        trackedObjects.forEach(obj => obj.life--);
        detections.forEach(det => {
            const match = trackedObjects.find(obj => {
                const dx = obj.bbox[0] - det.bbox[0]; const dy = obj.bbox[1] - det.bbox[1];
                return Math.sqrt(dx*dx + dy*dy) < 60;
            });
            if (match) { match.bbox = det.bbox; match.score = det.score; match.life = 10; } 
            else { trackedObjects.push({ bbox: det.bbox, class: det.class, score: det.score, life: 10, color: det.color }); }
            if(det.class === 'person') { MATCH_DATA.heatmapPoints.push({ x: Math.floor((det.bbox[0] + det.bbox[2]/2) / canvas.width * 1000), y: Math.floor((det.bbox[1] + det.bbox[3]) / canvas.height * 600), value: 1 }); }
        });
        trackedObjects = trackedObjects.filter(obj => obj.life > 0);
        document.getElementById('dataPointsCount').innerText = MATCH_DATA.heatmapPoints.length;
        if(MATCH_DATA.heatmapPoints.length > 5000) MATCH_DATA.heatmapPoints.splice(0, 1000);
        MATCH_DATA.totalFrames++;
    }

    function drawSmartTracking() {
        const canvas = document.getElementById('aiCanvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        trackedObjects.forEach(obj => {
            const [x, y, width, height] = obj.bbox;
            const isBall = obj.class === 'sports ball';
            const color = isBall ? '#f59e0b' : '#6366f1';
            ctx.beginPath();
            ctx.ellipse(x + width / 2, y + height, width / 2, width / 5, 0, 0, 2 * Math.PI);
            ctx.fillStyle = color; ctx.globalAlpha = 0.4; ctx.fill();
            ctx.globalAlpha = 1.0; ctx.lineWidth = 2; ctx.strokeStyle = color; ctx.stroke();
        });
    }

    function injectDummyData() {
        // FORCE DATA PARA QUE EL DASHBOARD NO SE VEA VACIO
        if(MATCH_DATA.heatmapPoints.length === 0) {
            MATCH_DATA.heatmapPoints = [{x:100,y:100,value:10}, {x:500,y:300,value:10}, {x:800,y:200,value:10}];
        }
        if(MATCH_DATA.shots.length === 0) {
            MATCH_DATA.shots = [{x:0.9, y:0.5, result:'gol'}, {x:0.1, y:0.5, result:'atajada'}, {x:0.8, y:0.4, result:'tiro'}];
        }
        // Charts Initial Data
        try {
            const ctxP = document.getElementById('possessionChart').getContext('2d');
            if(possessionChart) possessionChart.destroy();
            possessionChart = new Chart(ctxP, { type: 'doughnut', data: { labels: ['Local', 'Visita'], datasets: [{ data: [55, 45], backgroundColor: ['#3b82f6', '#ef4444'], borderWidth:0 }] }, options: { cutout: '70%', plugins: { legend: { display: false } } } });
            
            const ctxM = document.getElementById('momentumChart').getContext('2d');
            if(momentumChartInstance) momentumChartInstance.destroy();
            momentumChartInstance = new Chart(ctxM, { type: 'line', data: { labels: [1,2,3,4,5,6,7], datasets: [{ data: [0,5,-5,10,2,8,0], borderColor: '#6366f1', fill:true, backgroundColor:'rgba(99,102,241,0.1)' }] }, options: { responsive:true, maintainAspectRatio:false, scales:{x:{display:false}, y:{display:false}} } });
            
            // Radar
            const ctxR = document.getElementById('playerRadarChart').getContext('2d');
            if(radarChartInstance) radarChartInstance.destroy();
            radarChartInstance = new Chart(ctxR, { type: 'radar', data: { labels: ['At', 'Def', 'Pas', 'Fis', 'Tac'], datasets: [{ label: 'Alexis', data: [90, 40, 85, 80, 75], backgroundColor: 'rgba(99,102,241,0.2)', borderColor: '#6366f1' }] }, options: { scales: { r: { grid: { color: 'rgba(255,255,255,0.1)' }, angleLines: { color: 'rgba(255,255,255,0.1)' } } } } });

            // Comparison
            const ctxC = document.getElementById('comparisonChart').getContext('2d');
            if(comparisonChartInstance) comparisonChartInstance.destroy();
            comparisonChartInstance = new Chart(ctxC, { type: 'bar', data: { labels: ['Goles', 'Asist', 'Robos'], datasets: [{ label: 'Alexis', data: [5, 2, 8], backgroundColor: '#6366f1' }, { label: 'Ben', data: [3, 4, 12], backgroundColor: '#10b981' }] }, options: { scales: { x: { grid: { display: false } }, y: { grid: { color: 'rgba(255,255,255,0.1)' } } } } });

            // Indiv Heatmap
             if(document.getElementById('indivHeatmapContainer').children.length === 0) {
                 individualHeatmapInstance = h337.create({ container: document.getElementById('indivHeatmapContainer'), radius: 20 });
                 individualHeatmapInstance.setData({ max: 10, data: [{x:150, y:100, value:10}, {x:200, y:200, value:8}] });
             }

        } catch(e) { console.log("Charts init warning", e); }
    }

    function updateDashboardVisuals() {
        const container = document.getElementById('heatmapContainer');
        const shotContainer = document.getElementById('shotmapContainer');
        const passContainer = document.getElementById('passLinesSvg');
        const nodesLayer = document.getElementById('passNodesLayer');
        const actionContainer = document.getElementById('actionSvg');
        
        if(!container) return;
        
        // Mantener visibilidad segun modo
        // Limpiar solo contenido interno
        
        let dataToShow = MATCH_DATA.heatmapPoints;
        let shotsToShow = MATCH_DATA.shots;

        if (dataToShow.length < 5) injectDummyData(); // Fallback

        // HEATMAP
        if(!heatmapInstance) heatmapInstance = h337.create({ container: container, radius: 25 });
        const w = container.offsetWidth;
        const h = container.offsetHeight;
        
        // Solo actualizar si visible
        if(container.classList.contains('hidden-layer') === false) {
             heatmapInstance.setData({ max: 50, data: dataToShow.map(p => ({ x: Math.floor((p.x / 1000) * w) || p.x, y: Math.floor((p.y / 600) * h) || p.y, value: 10 })) });
        }
        
        // SHOTMAP
        shotContainer.innerHTML = '';
        shotsToShow.forEach(shot => {
            const el = document.createElement('div');
            el.className = `shot-marker shot-${shot.result==='gol'?'gol':'atajada'}`;
            // Adjust colors for classes
            if(shot.result==='tiro') el.style.backgroundColor='#f59e0b';
            
            el.style.left = `${shot.x * 100}%`; el.style.top = `${shot.y * 100}%`;
            el.addEventListener('mouseenter', (e) => {
                const t = document.getElementById('tacticalTooltip');
                let typeText = shot.result.toUpperCase();
                t.innerHTML = `<div style="font-weight:bold">${typeText}</div>`;
                t.style.display = 'block'; t.style.left = (e.clientX + 15) + 'px'; t.style.top = (e.clientY - 15) + 'px';
            });
            el.addEventListener('mouseleave', () => document.getElementById('tacticalTooltip').style.display='none');
            shotContainer.appendChild(el);
        });

        // PASS NETWORK
        if (passContainer && nodesLayer) {
            passContainer.innerHTML = ''; nodesLayer.innerHTML = ''; actionContainer.innerHTML = '';
            
            const positions = { 'POR': {x: 10, y: 50}, 'DEF': {x: 30, y: 50}, 'MED': {x: 50, y: 50}, 'DEL': {x: 80, y: 50} };
            
            squadDB.forEach(p => {
                const el = document.createElement('div');
                el.className = 'player-node';
                // Use Memory or Default
                let pos = MATCH_DATA.nodePositions[p.id];
                if(!pos) {
                    let defPos = positions[p.pos] || {x:50, y:50};
                    pos = { x: defPos.x + (p.id%10), y: defPos.y + (p.id%5) }; 
                }

                el.style.left = pos.x + "%"; el.style.top = pos.y + "%";
                el.textContent = p.num;

                // Drag Logic
                el.onmousedown = function(e) {
                    let containerRect = document.getElementById('canchaWrapper').getBoundingClientRect();
                    let shiftX = e.clientX - el.getBoundingClientRect().left;
                    let shiftY = e.clientY - el.getBoundingClientRect().top;
                    el.style.zIndex = 1000;
                    function moveAt(pageX, pageY) {
                        let newLeft = pageX - shiftX - containerRect.left;
                        let newTop = pageY - shiftY - containerRect.top;
                        if(newLeft < 0) newLeft = 0; if(newLeft > containerRect.width - 30) newLeft = containerRect.width - 30;
                        if(newTop < 0) newTop = 0; if(newTop > containerRect.height - 30) newTop = containerRect.height - 30;
                        let pctX = (newLeft / containerRect.width * 100);
                        let pctY = (newTop / containerRect.height * 100);
                        el.style.left = pctX + '%'; el.style.top = pctY + '%';
                        const zone = document.getElementById(`zone-${p.id}`);
                        if(zone) { zone.setAttribute("cx", pctX + "%"); zone.setAttribute("cy", pctY + "%"); }
                    }
                    function onMouseMove(e) { moveAt(e.clientX, e.clientY); }
                    document.addEventListener('mousemove', onMouseMove);
                    document.onmouseup = function() { 
                        document.removeEventListener('mousemove', onMouseMove); 
                        document.onmouseup = null; 
                        let rect = el.getBoundingClientRect();
                        let finalPctX = ((rect.left - containerRect.left) / containerRect.width) * 100;
                        let finalPctY = ((rect.top - containerRect.top) / containerRect.height) * 100;
                        MATCH_DATA.nodePositions[p.id] = {x: finalPctX, y: finalPctY};
                    };
                };
                el.ondragstart = function() { return false; };
                nodesLayer.appendChild(el);

                if(actionContainer) {
                    let rx = 5, ry = 5;
                    if(p.pos === 'DEF') { rx = 8; ry = 18; } if(p.pos === 'MED') { rx = 14; ry = 14; } if(p.pos === 'DEL') { rx = 18; ry = 10; }
                    const zone = document.createElementNS("http://www.w3.org/2000/svg", "ellipse");
                    zone.setAttribute("cx", pos.x + "%"); zone.setAttribute("cy", pos.y + "%");
                    zone.setAttribute("rx", rx + "%"); zone.setAttribute("ry", ry + "%");
                    zone.setAttribute("id", `zone-${p.id}`);
                    zone.setAttribute("class", `action-zone zone-${p.pos.toLowerCase()}`);
                    actionContainer.appendChild(zone);
                }
            });
        }
        
        document.getElementById('kpiFrames').innerText = MATCH_DATA.totalFrames || 100;
    }

    window.applyFormation = function(fmt) {
        const layer = document.getElementById('tacticsLayer');
        if(!layer) return;
        layer.innerHTML = '';
        const starting11 = squadDB.slice(0, 11);
        let coords = fmt === '442' ? [{x: 5, y: 50}, {x: 25, y: 20}, {x: 25, y: 40}, {x: 25, y: 60}, {x: 25, y: 80}, {x: 55, y: 20}, {x: 55, y: 40}, {x: 55, y: 60}, {x: 55, y: 80}, {x: 85, y: 40}, {x: 85, y: 60}] : [{x: 5, y: 50}, {x: 25, y: 15}, {x: 25, y: 38}, {x: 25, y: 62}, {x: 25, y: 85}, {x: 50, y: 30}, {x: 45, y: 50}, {x: 50, y: 70}, {x: 80, y: 20}, {x: 85, y: 50}, {x: 80, y: 80}];
        
        starting11.forEach((p, i) => {
            if (!coords[i]) return;
            const el = document.createElement('div');
            el.className = 'player-node';
            
            // Check Tactics Memory (Separate from Dashboard Memory)
            // For simplicity in this fix, we re-use same logic or just use Formation coords
            // In a full app, use MATCH_DATA.tacticsPositions
            
            el.style.left = coords[i].x + "%"; el.style.top = coords[i].y + "%";
            el.textContent = p.num;
            
            el.addEventListener('mouseenter', (e) => {
                const t = document.getElementById('tacticalTooltip');
                t.innerHTML = `<div style="font-weight:bold">${p.name}</div><div style="font-size:0.75rem; opacity:0.8">${p.pos}</div>`;
                t.style.display = 'block'; t.style.left = (e.clientX + 15) + 'px'; t.style.top = (e.clientY - 15) + 'px';
            });
            el.addEventListener('mouseleave', () => { document.getElementById('tacticalTooltip').style.display = 'none'; });

            // DRAG TACTICS
             el.onmousedown = function(e) {
                let containerRect = document.getElementById('tacticsWrapper').getBoundingClientRect();
                let shiftX = e.clientX - el.getBoundingClientRect().left;
                let shiftY = e.clientY - el.getBoundingClientRect().top;
                el.style.zIndex = 1000;
                function moveAt(pageX, pageY) {
                    let newLeft = pageX - shiftX - containerRect.left;
                    let newTop = pageY - shiftY - containerRect.top;
                    // Clamp
                    if(newLeft < 0) newLeft = 0; if(newLeft > containerRect.width - 30) newLeft = containerRect.width - 30;
                    if(newTop < 0) newTop = 0; if(newTop > containerRect.height - 30) newTop = containerRect.height - 30;
                    el.style.left = (newLeft / containerRect.width * 100) + '%';
                    el.style.top = (newTop / containerRect.height * 100) + '%';
                }
                function onMouseMove(e) { moveAt(e.clientX, e.clientY); }
                document.addEventListener('mousemove', onMouseMove);
                document.onmouseup = function() { document.removeEventListener('mousemove', onMouseMove); document.onmouseup = null; };
            };
            el.ondragstart = function() { return false; };
            layer.appendChild(el);
        });
    };

    window.resetTactics = function() { applyFormation(document.getElementById('tacticalFormationSelect').value); };
    window.forceHeatmapUpdate = function() { 
        if(document.getElementById('passNodesLayer').innerHTML !== '') { MATCH_DATA.nodePositions = {}; }
        updateDashboardVisuals(); showToast("Mapa regenerado"); 
    };

    // === UI HELPERS ===
    window.filterSquad = function(c, b){currentFilter=c; document.querySelectorAll('.filter-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); renderSquad();};
    window.filterSquadByName = function(v){currentSearch=v.toLowerCase(); renderSquad();};
    window.openAddPlayerModal = function(){document.getElementById('addPlayerModal').style.display='block'};
    window.closeAddPlayerModal = function(){document.getElementById('addPlayerModal').style.display='none'};
    window.saveNewPlayer = function(){ const n=document.getElementById('newPlayerName').value, m=document.getElementById('newPlayerNum').value, o=document.getElementById('newPlayerPos').value; if(n&&m){ squadDB.push({id:Date.now(),name:n,num:m,pos:o,status:'fit'}); localStorage.setItem('pitada_squad', JSON.stringify(squadDB)); closeAddPlayerModal(); renderSquad(); showToast("Fichado"); } };
    window.toggleProfileMenu = function() { document.getElementById('profileDropdown').classList.toggle('show'); };
    window.onclick = function(e) { if(!e.target.closest('.profile-btn'))document.getElementById('profileDropdown').classList.remove('show'); };
    
    window.setBoardMode = function(m, b) { 
        document.querySelectorAll('.mode-btn').forEach(btn=>btn.classList.remove('active')); b.classList.add('active');
        ['heatmapContainer', 'shotmapContainer', 'passmapContainer', 'actionmapContainer'].forEach(id => { const el = document.getElementById(id); if(el) el.classList.add('hidden-layer'); });
        if(m==='heatmap') document.getElementById('heatmapContainer').classList.remove('hidden-layer');
        if(m==='shotmap') document.getElementById('shotmapContainer').classList.remove('hidden-layer');
        if(m==='passmap') document.getElementById('passmapContainer').classList.remove('hidden-layer');
        if(m==='actionmap') document.getElementById('actionmapContainer').classList.remove('hidden-layer');
    };
    
    window.toggleTheme = function(){const h=document.documentElement; h.classList.toggle('dark'); localStorage.setItem('theme', h.classList.contains('dark')?'dark':'light');};

    // MISSING STUBS
    window.updateHeatmap = function(){}; window.changePlayer=function(){}; window.updateComparison=function(){}; window.updateIndividualHeatmap=function(){}; window.deletePlayer=function(){}; window.confirmDeletePlayer=function(){}; window.changeStatus=function(){};

    // === INIT ON LOAD ===
    document.addEventListener('DOMContentLoaded', function() {
        if(localStorage.getItem('theme')==='light') document.documentElement.classList.remove('dark');
        renderVideoEvents(); 
        renderSquad();
        injectDummyData(); // THIS IS KEY FOR CHARTS
        setTimeout(updateDashboardVisuals, 500);
        
        // RE-BIND VIDEO INPUT
        document.getElementById('videoInput').onchange = function(e) {
            const file = e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                const video = document.getElementById('matchVideo');
                document.getElementById('videoPlaceholder').style.display = 'none';
                video.style.display = 'block';
                video.src = url;
                showToast(`Partido "${file.name}" cargado.`);
                MATCH_DATA = { totalFrames: 0, playersHistory: [], possession: { local: 0, visit: 0 }, heatmapPoints: [], shots: [], passes: [], nodePositions: {} };
                localStorage.removeItem('pitada_video_events'); videoEvents = []; renderVideoEvents();
                document.getElementById('dataPointsCount').innerText = "0";
                navigate('videos');
            }
        };
    });
</script>
</body>
</html>
